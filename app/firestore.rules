rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    

		// Rules for the 'campaigns' collection

    match /campaigns/{campaignId} {

      // Allow read access to any authenticated user

      allow read: if request.auth != null;

      

      // Allow write access only to users with isAdmin == true

      allow write: if request.auth != null &&

        get(/databases/$(database)/documents/users/$(request.auth.uid))

          .data.isAdmin == true;

    }

    

    // Rules for the 'items' collection

    match /items/{itemId} {

      // Allow read access to any authenticated user

      allow read: if request.auth != null;

      // Allow write access only to users with isAdmin == true

      allow write: if request.auth != null &&

        get(/databases/$(database)/documents/users/$(request.auth.uid))

          .data.isAdmin == true;

    }

    

    // Rules for the 'products' collection

    match /products/{productId} {

      // Allow read access to any authenticated user

      allow read: if request.auth != null;

      // Allow write access only to users with isAdmin == true

      allow write: if request.auth != null &&

        get(/databases/$(database)/documents/users/$(request.auth.uid))

          .data.isAdmin == true;

    }
    
    // Rules for the 'requests' collection
    match /requests/{requestId} {
      // Allow user to read only their own requests
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Allow user to create a request tied to their own UID
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Only administrators can update request details (e.g., status changes)
      allow update: if request.auth != null && request.auth.token.admin == true;
    }
    
    // Rules for the 'applications' collection
    match /applications/{appId} {
      // Helper function to check if user is admin
      function isAdmin() {
        return request.auth != null && (
          request.auth.token.admin == true || 
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true)
        );
      }
      
      // Allow read if user owns the application OR is an admin
      // For collection queries, admins can read all, users can only read their own
      allow read: if request.auth != null && 
                     (isAdmin() || request.auth.uid == resource.data.userId);
      
      // Allow user to create an application tied to their own UID
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Only administrators can update application details (e.g., status changes)
      // Check both token admin and user document isAdmin field
      allow update: if request.auth != null && (
        request.auth.token.admin == true || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true)
      );
    }
    
    // Rules for the 'users' collection
    match /users/{userId} {
      // Helper function to check if user is admin
      function isAdmin() {
        return request.auth != null && (
          request.auth.token.admin == true || 
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true)
        );
      }
      
      // Allow read access if the user is the owner of the profile or an admin
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Allow write access if the user is the owner of the profile or an admin
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Rules for the 'applications' subcollection under users (legacy - for backward compatibility)
      match /applications/{applicationId} {
        // Allow users to create applications in their own subcollection
        allow create: if request.auth != null && request.auth.uid == userId;
        
        // Allow users to read their own applications
        allow read: if request.auth != null && request.auth.uid == userId;
        
        // Allow users to update their own applications (only if status is PENDING)
        allow update: if request.auth != null && 
                      request.auth.uid == userId &&
                      (resource.data.status == 'PENDING' || 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status']));
        
        // Allow administrators to update any application
        allow update: if request.auth != null && request.auth.token.admin == true;
        
        // Don't allow users to delete applications (or set to true if needed)
        allow delete: if false;
      }
    }
  }
}
